Documentation {#mainpage}
=============
[TOC]

# Introduction {#Introduction}

This is a profiling tool written in C++ and designed for use with the Unified
Model and LFRic.
The current implementation is a work in progress.

# Build Options {#Options}

There are a number of options which can be passed to CMake on the command line
or set using ccmake. Passing options to CMake via the command line looks something like this: `cmake -DBUILD_FORTRAN_TESTS=OFF -DBUILD_SHARED_LIBS=OFF`. Alternatively, `ccmake ..` will bring up a terminal wherein the user can change build options interactively. 

Argument | Options (Default **Bold**)| Description
:---:|:---:|:---
 `-DBUILD_TESTS`           |  **ON** / OFF | Build tests.
 `-DBUILD_FORTRAN_TESTS`   |  **ON** / OFF | Build Fortran tests.
 `-DINCLUDE_GTEST`         |  ON / **OFF** | Fetches and populates GoogleTest within the project build (requires `BUILD_TESTS=ON`).
 `-DENABLE_DOXYGEN`        |  **ON** / OFF | Build the Doxygen documentation.
 `-DBUILD_SHARED_LIBS`     |  **ON** / OFF | Determines whether the libraries are linked statically (`OFF`) or dynamically (`ON`). 


# Metrics {#Metrics}

The metrics to be included are going to be based on Performance Optimisation
and Productivity (<a href="https://pop-coe.eu/node/69">POP</a>) Standard Metrics 
for Parallel Performance Analysis.

### Load Balance

TBD

### Communication Efficiency

TBD

# Testing {#Testing}

## Unit Test Coverage

A detailed unit test coverage report (generated by Gcov and Lcov) can be found <a href="https://metoffice.github.io/profiler/coverage">here</a>.

## System Tests

The `tests/system_tests` directory contains one C++ and one Fortran system test. The idea behind these is to regularly test the installation of the public header files and libraries. Both are included in the CI testing, but for compiling and running these manually see the "Running Manually" section below.

Both tests also serve as examples of how calls to the profiler's API are made in their respective language. 

### Running Manually

The requirements and supported compilers can be found in the top-level repository README.

After checking out the profiler's repository and navigating to the root directory, an installation can be done by doing the following:

```
mkdir build
cd build
cmake ..
make
make install
```
By default the `include` and `lib` directories will appear in your build directory but this can be changed via the `-DCMAKE_INSTALL_PREFIX` cmake option.

It's now possible to compile and run one of the two system tests, the steps for doing so are outlined below depending on whether you want to run `system_test.cpp` or `system_test.f90`. 

> Note: both examples assume you're still in the build directory. The paths to the system tests and the "include"/"lib" directories ought to be altered if necessary.

### C++

```
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:./lib
mpicxx -o test ../tests/system_tests/system_test.cpp -I./include -L./lib -lprofiler -fopenmp
mpirun -n 4 ./test
```

### Fortran

```
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:./lib
mpifort -o test ../tests/system_tests/system_test.cpp -I./include -L./lib -lprofiler_f -lprofiler_c -fopenmp
mpirun -n 4 ./test
```