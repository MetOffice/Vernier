name: Run Unit Tests

on: 
#page_build ?
  workflow_run:
    workflows: [ "Build Dynamically", "Build Statically" ] 
    branches: [ main ]
    types: 
      - completed
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request: 
    branches: [ main ]

env: 
  BUILD_TYPE: Debug

jobs:
  run:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        threads: [1, 4]
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - run: echo "Triggering workflow was a success, running unit tests..."
      - uses: actions/checkout@v2

    ## DOwnload the binary artifact here???? <<<
      - uses: actions/download-artifact@v3 
        with:
          name: Upload-binary
          path: ${{ github.workspace }}/build

      # Run tests 
      - name: "Test (${{ matrix.threads }} threads)"
        env:
          OMP_NUM_THREADS: ${{ matrix.threads }}
        working-directory: ${{github.workspace}}/build
        run: ctest -VV -C ${{env.BUILD_TYPE}}

  dont-run:
    runs-on: ubunutu-latest 
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - run: echo "Triggering workflow failed"